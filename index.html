<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem POS Lengkap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Animation for modals and toasts */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .fade-out {
            animation: fadeOut 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        .toast-enter {
            animation: toastIn 0.5s forwards;
        }
        @keyframes toastIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-2"></div>

    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar Navigation -->
        <aside class="w-20 md:w-64 bg-white shadow-md flex flex-col">
            <div class="flex items-center justify-center md:justify-start p-4 border-b">
                <i class="fas fa-store text-blue-600 text-3xl"></i>
                <h1 class="text-2xl font-bold text-gray-800 ml-3 hidden md:block">POS App</h1>
            </div>
            <nav class="flex-1 px-2 py-4 space-y-2">
                <a href="#" id="nav-pos" class="flex items-center p-3 text-gray-700 bg-blue-100 rounded-lg">
                    <i class="fas fa-cash-register w-6 text-center text-blue-600"></i>
                    <span class="ml-4 font-semibold hidden md:block">POS</span>
                </a>
                <a href="#" id="nav-stock" class="flex items-center p-3 text-gray-700 hover:bg-gray-200 rounded-lg">
                    <i class="fas fa-boxes-stacked w-6 text-center text-gray-500"></i>
                    <span class="ml-4 font-semibold hidden md:block">Manajemen Stok</span>
                </a>
                 <a href="#" id="nav-staff" class="flex items-center p-3 text-gray-700 hover:bg-gray-200 rounded-lg">
                    <i class="fas fa-users w-6 text-center text-gray-500"></i>
                    <span class="ml-4 font-semibold hidden md:block">Manajemen Staff</span>
                </a>
                <a href="#" id="nav-dashboard" class="flex items-center p-3 text-gray-700 hover:bg-gray-200 rounded-lg">
                    <i class="fas fa-chart-line w-6 text-center text-gray-500"></i>
                    <span class="ml-4 font-semibold hidden md:block">Dashboard</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                <h2 id="page-title" class="text-2xl font-bold text-gray-800">Point of Sale</h2>
                <button id="add-product-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition duration-300 flex items-center">
                    <i class="fas fa-plus mr-2"></i>
                    <span>Tambah Produk</span>
                </button>
            </header>

            <!-- Page Content -->
            <div class="flex-1 p-6 overflow-y-auto">
                <!-- POS Page -->
                <div id="pos-page" class="flex flex-col lg:flex-row gap-6">
                    <!-- Products Grid -->
                    <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 flex-1">
                        <!-- Product cards will be inserted here by JavaScript -->
                    </div>
                    <!-- Cart Panel -->
                    <div class="lg:w-96 w-full bg-white rounded-lg shadow p-4 flex flex-col">
                        <h3 class="text-xl font-bold border-b pb-2">Keranjang</h3>
                        <div id="cart-items" class="flex-1 overflow-y-auto my-4 space-y-3">
                            <!-- Cart items will be inserted here -->
                            <p class="text-gray-500 text-center">Keranjang Anda kosong.</p>
                        </div>
                        <div class="border-t pt-4 space-y-4">
                            <div>
                                <label for="customer-name" class="text-sm font-medium text-gray-600">Nama Pelanggan</label>
                                <input type="text" id="customer-name" placeholder="Opsional" class="mt-1 w-full border rounded-md px-2 py-2 text-sm">
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Metode Bayar</span>
                                <select id="payment-method" class="border rounded-md px-2 py-1">
                                    <option value="Cash">Cash</option>
                                    <option value="Qris">QRIS</option>
                                </select>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Staff Bertugas</span>
                                <select id="staff-dropdown" class="border rounded-md px-2 py-1">
                                    <!-- Staff options will be inserted here -->
                                </select>
                            </div>
                            <div class="flex justify-between items-center font-bold text-lg">
                                <span>Total</span>
                                <span id="cart-total">Rp 0</span>
                            </div>
                            <button id="complete-transaction-btn" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition duration-300 disabled:bg-gray-400">
                                Selesaikan Transaksi
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stock Management Page -->
                <div id="stock-page" class="hidden">
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok Saat Ini</th>
                                    <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Update Stok</th>
                                </tr>
                            </thead>
                            <tbody id="stock-list" class="bg-white divide-y divide-gray-200">
                                <!-- Stock items will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Staff Management Page -->
                <div id="staff-page" class="hidden space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4">Tambah Staff Baru</h3>
                        <form id="add-staff-form" class="flex items-center gap-4">
                            <input type="text" id="new-staff-name" placeholder="Nama Staff" required class="flex-grow border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Tambah</button>
                        </form>
                    </div>
                    <div class="bg-white rounded-lg shadow">
                        <h3 class="text-xl font-bold p-6 border-b">Daftar Staff</h3>
                        <ul id="staff-list" class="divide-y divide-gray-200">
                            <!-- Staff list will be inserted here -->
                        </ul>
                    </div>
                </div>

                <!-- Dashboard Page -->
                <div id="dashboard-page" class="hidden space-y-6">
                     <!-- Filter and Stats -->
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <h3 class="text-xl font-bold text-gray-700">Ringkasan Penjualan</h3>
                        <div>
                            <select id="dashboard-filter" class="border rounded-md px-3 py-2">
                                <option value="today">Hari Ini</option>
                                <option value="7days">7 Hari Terakhir</option>
                                <option value="30days">30 Hari Terakhir</option>
                                <option value="all">Semua</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow flex items-center">
                            <div class="bg-blue-100 rounded-full p-3 mr-4">
                               <i class="fas fa-dollar-sign text-blue-600 text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Total Pendapatan</p>
                                <p id="stats-revenue" class="text-2xl font-bold">Rp 0</p>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow flex items-center">
                            <div class="bg-green-100 rounded-full p-3 mr-4">
                               <i class="fas fa-receipt text-green-600 text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Jumlah Transaksi</p>
                                <p id="stats-transactions" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                         <div class="bg-white rounded-lg shadow p-6 flex items-center">
                            <div class="bg-yellow-100 rounded-full p-3 mr-4">
                               <i class="fas fa-box text-yellow-600 text-2xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Produk Terjual</p>
                                <p id="stats-products-sold" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Best Sellers and Transaction History -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow">
                            <h4 class="text-lg font-bold mb-4">Produk Terlaris</h4>
                            <ul id="best-sellers-list" class="space-y-3">
                                <!-- Best seller items -->
                            </ul>
                        </div>
                        <div class="lg:col-span-2 bg-white rounded-lg shadow overflow-hidden">
                            <h4 class="text-lg font-bold p-6">Riwayat Transaksi</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Pelanggan</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Staff</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Metode</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transaction-history" class="bg-white divide-y divide-gray-200">
                                        <!-- History items -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center hidden fade-in">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Tambah Produk Baru</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="space-y-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700">Nama Produk</label>
                        <input type="text" id="product-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="product-price" class="block text-sm font-medium text-gray-700">Harga</label>
                        <input type="number" id="product-price" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="product-stock" class="block text-sm font-medium text-gray-700">Stok Awal</label>
                        <input type="number" id="product-stock" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="product-image" class="block text-sm font-medium text-gray-700">URL Gambar</label>
                        <input type="url" id="product-image" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="cancel-product-modal-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Batal</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Transaction Modal -->
    <div id="edit-transaction-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center hidden fade-in">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">Edit Transaksi</h2>
            <form id="edit-transaction-form">
                <input type="hidden" id="edit-transaction-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-customer-name" class="block text-sm font-medium text-gray-700">Nama Pelanggan</label>
                        <input type="text" id="edit-customer-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="edit-payment-method" class="block text-sm font-medium text-gray-700">Metode Bayar</label>
                        <select id="edit-payment-method" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="Cash">Cash</option>
                            <option value="Qris">QRIS</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-staff-name" class="block text-sm font-medium text-gray-700">Staff Bertugas</label>
                        <select id="edit-staff-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                           <!-- Staff options will be populated here -->
                        </select>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="cancel-edit-transaction-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Batal</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // =================================================================================
    // CONFIGURATION
    // =================================================================================
    // TODO: Ganti dengan URL Google Apps Script Web App Anda YANG BARU setelah di-deploy
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxhYukbcdIlTHNSJEAARxlyAHgvAsW0MNQo9Y3z6ZYlYlxj5L3Bq-IAiyAj6sF18rf8/exec'; // <-- PENTING: ISI URL DEPLOYMENT APPS SCRIPT ANDA DI SINI

    // =================================================================================
    // STATE MANAGEMENT
    // =================================================================================
    let products = [];
    let cart = [];
    let transactions = [];
    let staff = [];
    let currentPage = 'pos';

    // =================================================================================
    // DOM ELEMENTS
    // =================================================================================
    const loadingOverlay = document.getElementById('loading-overlay');
    const pageTitle = document.getElementById('page-title');
    const pages = {
        pos: document.getElementById('pos-page'),
        stock: document.getElementById('stock-page'),
        staff: document.getElementById('staff-page'),
        dashboard: document.getElementById('dashboard-page'),
    };
    const navLinks = {
        pos: document.getElementById('nav-pos'),
        stock: document.getElementById('nav-stock'),
        staff: document.getElementById('nav-staff'),
        dashboard: document.getElementById('nav-dashboard'),
    };
    const productGrid = document.getElementById('product-grid');
    const cartItemsContainer = document.getElementById('cart-items');
    const cartTotalEl = document.getElementById('cart-total');
    const completeTransactionBtn = document.getElementById('complete-transaction-btn');
    const addProductBtn = document.getElementById('add-product-btn');
    
    // Product Modal Elements
    const productModal = document.getElementById('product-modal');
    const productForm = document.getElementById('product-form');
    const cancelProductModalBtn = document.getElementById('cancel-product-modal-btn');
    const modalTitle = document.getElementById('modal-title');
    
    // Transaction Edit Modal Elements
    const editTransactionModal = document.getElementById('edit-transaction-modal');
    const editTransactionForm = document.getElementById('edit-transaction-form');
    const cancelEditTransactionBtn = document.getElementById('cancel-edit-transaction-btn');

    const stockListContainer = document.getElementById('stock-list');
    const staffListContainer = document.getElementById('staff-list');
    const addStaffForm = document.getElementById('add-staff-form');
    const staffDropdown = document.getElementById('staff-dropdown');
    const customerNameInput = document.getElementById('customer-name');
    const dashboardFilter = document.getElementById('dashboard-filter');

    // =================================================================================
    // UTILITY & HELPER FUNCTIONS
    // =================================================================================
    
    const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    
    const showLoader = () => loadingOverlay.style.display = 'flex';
    const hideLoader = () => loadingOverlay.style.display = 'none';

    const showToast = (message, type = 'success') => {
        const toastContainer = document.getElementById('toast-container');
        const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';

        const toast = document.createElement('div');
        toast.className = `toast-enter text-white px-6 py-4 rounded-md shadow-lg flex items-center ${bgColor}`;
        toast.innerHTML = `<i class="fas ${icon} mr-3"></i><p>${message}</p>`;
        
        toastContainer.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    };

    // =================================================================================
    // RENDER FUNCTIONS
    // =================================================================================

    const renderProducts = () => {
        productGrid.innerHTML = '';
        if (products.length === 0) {
            productGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center">Belum ada produk. Silakan tambahkan produk baru.</p>';
            return;
        }
        products.forEach(p => {
            const disabled = p.stock <= 0 ? 'disabled' : '';
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow p-4 flex flex-col relative';
            card.innerHTML = `
                <div class="absolute top-2 right-2">
                    <button class="text-gray-500 hover:text-gray-800 focus:outline-none" onclick="toggleProductMenu('${p.id}')">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div id="menu-${p.id}" class="hidden absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg z-10">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" onclick="handleEditProduct('${p.id}')">Edit</a>
                        <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100" onclick="handleDeleteProduct('${p.id}')">Hapus</a>
                    </div>
                </div>
                <img src="${p.image}" alt="${p.name}" class="w-full h-32 object-cover rounded-md mb-4" onerror="this.onerror=null;this.src='https://placehold.co/300x200/e2e8f0/adb5bd?text=Gambar\\nTdk\\nTersedia';">
                <h4 class="text-md font-bold text-gray-800 flex-1">${p.name}</h4>
                <p class="text-gray-600">${formatCurrency(p.price)}</p>
                <p class="text-sm ${p.stock > 5 ? 'text-green-600' : 'text-red-600'}">Stok: ${p.stock}</p>
                <button ${disabled} onclick="addToCart('${p.id}')" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Tambah
                </button>
            `;
            productGrid.appendChild(card);
        });
    };
    
    const renderCart = () => {
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center">Keranjang Anda kosong.</p>';
            cartTotalEl.textContent = formatCurrency(0);
            completeTransactionBtn.disabled = true;
            return;
        }

        cartItemsContainer.innerHTML = '';
        let total = 0;
        cart.forEach(item => {
            const product = products.find(p => p.id === item.id);
            if (!product) return; // Skip if product not found
            total += product.price * item.quantity;

            const cartItemEl = document.createElement('div');
            cartItemEl.className = 'flex justify-between items-center';
            cartItemEl.innerHTML = `
                <div class="flex items-center min-w-0">
                    <img src="${product.image}" alt="${product.name}" class="w-12 h-12 object-cover rounded-md mr-3" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/adb5bd?text=Img';">
                    <div class="min-w-0">
                        <p class="font-semibold truncate">${product.name}</p>
                        <p class="text-sm text-gray-500">${formatCurrency(product.price)}</p>
                    </div>
                </div>
                <div class="flex items-center flex-shrink-0">
                    <button onclick="updateCartQuantity('${item.id}', -1)" class="w-6 h-6 bg-gray-200 rounded-full font-bold">-</button>
                    <span class="mx-2">${item.quantity}</span>
                    <button onclick="updateCartQuantity('${item.id}', 1)" class="w-6 h-6 bg-gray-200 rounded-full font-bold">+</button>
                </div>
            `;
            cartItemsContainer.appendChild(cartItemEl);
        });

        cartTotalEl.textContent = formatCurrency(total);
        completeTransactionBtn.disabled = false;
    };
    
    const renderStockPage = () => {
        stockListContainer.innerHTML = '';
        if (products.length === 0) {
            stockListContainer.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Belum ada produk.</td></tr>';
            return;
        }
        products.forEach(p => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            <img class="h-10 w-10 rounded-full object-cover" src="${p.image}" alt="${p.name}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/adb5bd?text=Img';">
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${p.name}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${p.stock > 5 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${p.stock}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div class="flex items-center">
                        <input type="number" min="1" id="stock-update-${p.id}" class="w-20 border-gray-300 rounded-md shadow-sm" placeholder="Jumlah">
                        <button onclick="updateStock('${p.id}', 'add')" class="ml-2 bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600"><i class="fas fa-plus"></i></button>
                        <button onclick="updateStock('${p.id}', 'subtract')" class="ml-2 bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600"><i class="fas fa-minus"></i></button>
                    </div>
                </td>
            `;
            stockListContainer.appendChild(row);
        });
    };
    
    const renderStaffPage = () => {
        staffListContainer.innerHTML = '';
        if(staff.length === 0) {
            staffListContainer.innerHTML = '<li class="px-6 py-4 text-center text-gray-500">Belum ada staff terdaftar.</li>';
            return;
        }
        staff.forEach(s => {
            const li = document.createElement('li');
            li.className = 'px-6 py-4 flex justify-between items-center';
            li.innerHTML = `
                <span class="text-gray-800 font-medium">${s.name}</span>
                <button onclick="handleDeleteStaff('${s.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button>
            `;
            staffListContainer.appendChild(li);
        });
    };

    const renderStaffDropdown = (selectElement) => {
        selectElement.innerHTML = '';
        if (staff.length === 0) {
            selectElement.innerHTML = '<option value="">- Belum ada staff -</option>';
        } else {
             selectElement.innerHTML = '<option value="">Pilih Staff</option>';
        }
        staff.forEach(s => {
            const option = document.createElement('option');
            option.value = s.name;
            option.textContent = s.name;
            selectElement.appendChild(option);
        });
    };

    const renderAllDropdowns = () => {
        renderStaffDropdown(staffDropdown);
        renderStaffDropdown(document.getElementById('edit-staff-name'));
    };

    const renderDashboard = () => {
        const filter = dashboardFilter.value;
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        let filteredTransactions = transactions;

        if (filter !== 'all') {
            let daysToSubtract = 0;
            if (filter === 'today') daysToSubtract = 0;
            if (filter === '7days') daysToSubtract = 7;
            if (filter === '30days') daysToSubtract = 30;

            const startDate = new Date(today);
            if (filter !== 'today') {
               startDate.setDate(today.getDate() - daysToSubtract + 1); // Start from the beginning of the day
            }
           
            filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                if (filter === 'today') {
                    return transactionDate.getFullYear() === today.getFullYear() &&
                           transactionDate.getMonth() === today.getMonth() &&
                           transactionDate.getDate() === today.getDate();
                }
                return transactionDate >= startDate;
            });
        }
        
        // Stats
        const totalRevenue = filteredTransactions.reduce((sum, t) => sum + t.total, 0);
        const totalTransactions = filteredTransactions.length;
        const totalProductsSold = filteredTransactions.reduce((sum, t) => sum + (t.items ? t.items.reduce((itemSum, item) => itemSum + item.quantity, 0) : 0), 0);

        
        document.getElementById('stats-revenue').textContent = formatCurrency(totalRevenue);
        document.getElementById('stats-transactions').textContent = totalTransactions;
        document.getElementById('stats-products-sold').textContent = totalProductsSold;

        // Best Sellers
        const productSales = {};
        filteredTransactions.forEach(t => {
            if(!t.items) return; // Skip if transaction has no items
            t.items.forEach(item => {
                if (!productSales[item.id]) {
                    const product = products.find(p => p.id === item.id);
                    productSales[item.id] = { name: product ? product.name : 'Produk Dihapus', quantity: 0 };
                }
                productSales[item.id].quantity += item.quantity;
            });
        });
        const sortedProducts = Object.values(productSales).sort((a, b) => b.quantity - a.quantity).slice(0, 5);
        const bestSellersList = document.getElementById('best-sellers-list');
        bestSellersList.innerHTML = '';
        if (sortedProducts.length === 0) {
            bestSellersList.innerHTML = '<p class="text-gray-500">Tidak ada data penjualan.</p>';
        } else {
            sortedProducts.forEach(p => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center';
                li.innerHTML = `<span>${p.name}</span> <span class="font-bold">${p.quantity} terjual</span>`;
                bestSellersList.appendChild(li);
            });
        }
        
        // Transaction History
        const transactionHistory = document.getElementById('transaction-history');
        transactionHistory.innerHTML = '';
        if (filteredTransactions.length === 0) {
            transactionHistory.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Tidak ada transaksi.</td></tr>';
        } else {
            filteredTransactions.slice().reverse().forEach(t => { // Show newest first
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-4 text-sm text-gray-900">${new Date(t.date).toLocaleString('id-ID')}</td>
                    <td class="px-4 py-4 text-sm text-gray-500">${t.customerName || '-'}</td>
                    <td class="px-4 py-4 text-sm text-gray-500">${t.staffName || '-'}</td>
                    <td class="px-4 py-4 text-sm text-gray-900 font-semibold">${formatCurrency(t.total)}</td>
                    <td class="px-4 py-4 text-sm text-gray-500">${t.paymentMethod}</td>
                    <td class="px-4 py-4 text-sm text-gray-500">
                        <button onclick="handleEditTransaction('${t.id}')" class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button>
                        <button onclick="handleDeleteTransaction('${t.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                transactionHistory.appendChild(row);
            });
        }
    };
    
    // =================================================================================
    // API CALLS (Google Apps Script)
    // =================================================================================
    const callAppsScript = async (action, payload) => {
        if (!SCRIPT_URL) {
            showToast('URL Google Apps Script belum diatur!', 'error');
            console.error("SCRIPT_URL is not set.");
            hideLoader();
            return { success: false, message: 'URL Google Apps Script belum diatur!' };
        }
        
        showLoader();
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Changed to no-cors for simple POST requests to GAS
                headers: {
                  'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify({ action, payload })
            });
            
            // For 'no-cors', we can't read the response, so we'll have to rely on a subsequent fetch or assume success
            // A better approach is a full CORS response from GAS, but this is simpler
            // Let's reload the data after any action that modifies it
            return { success: true }; // Assume success for now
        } catch (error) {
            console.error('Error calling Apps Script:', error);
            showToast('Gagal terhubung ke backend.', 'error');
            console.log("Tips: Pastikan Google Apps Script sudah di-deploy ulang (Deploy > Manage deployments > Edit > New version > Deploy) dengan akses diatur ke 'Anyone'. Pastikan juga URL di variabel SCRIPT_URL sudah benar.");
            return { success: false, error: error.message };
        } finally {
            // We reload data on every mutation action to get the latest state
            if(action !== 'getInitialData'){
                await loadInitialData();
            }
            hideLoader();
        }
    };

    const loadInitialData = async () => {
        showLoader();
        try {
            // A direct fetch to a GAS web app needs to be handled differently.
            // A POST request often gets a redirect, which can be tricky.
            // Let's construct a GET-like request in the URL for initial data load.
             const getUrl = SCRIPT_URL + "?action=getInitialData";
             const response = await fetch(getUrl, {
                method: 'GET',
                mode: 'cors',
                redirect: 'follow'
             });

            if (!response.ok) {
                 throw new Error(`Network response was not ok: ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result && result.success) {
                products = result.data.products || [];
                staff = result.data.staff || [];
                transactions = result.data.transactions || [];
                
                renderProducts();
                renderCart();
                renderAllDropdowns();
                if(currentPage === 'dashboard') renderDashboard();
            } else {
                 throw new Error(result.message || 'Failed to parse initial data.');
            }
        } catch(error) {
            console.error("Could not fetch from backend. Using mock data.", error);
            showToast('Gagal memuat data, menggunakan data contoh.', 'error');
            products = [
                { id: 'prod1', name: 'Kopi Susu Gula Aren', price: 18000, stock: 20, image: 'https://placehold.co/300x200/663300/FFFFFF?text=Kopi+Susu' },
                { id: 'prod2', name: 'Croissant Cokelat', price: 22000, stock: 15, image: 'https://placehold.co/300x200/D2691E/FFFFFF?text=Croissant' },
                { id: 'prod3', name: 'Matcha Latte', price: 25000, stock: 0, image: 'https://placehold.co/300x200/3CB371/FFFFFF?text=Matcha' }
            ];
            staff = [
                { id: 'staff1', name: 'Andi' },
                { id: 'staff2', name: 'Bunga' }
            ];
            transactions = [];
            renderProducts();
            renderAllDropdowns();
        } finally {
            hideLoader();
        }
    };
    
    // =================================================================================
    // EVENT HANDLERS & LOGIC
    // =================================================================================
    const switchPage = (pageName) => {
        currentPage = pageName;
        Object.values(pages).forEach(page => page.style.display = 'none');
        Object.values(navLinks).forEach(link => {
            link.classList.remove('bg-blue-100');
            link.querySelector('i').classList.replace('text-blue-600', 'text-gray-500');
        });
        
        pages[pageName].style.display = pages[pageName].id.includes('page') ? 'block' : 'flex';
        if (pages[pageName].id === 'pos-page') pages[pageName].style.display = 'flex'; // POS page needs flex display

        navLinks[pageName].classList.add('bg-blue-100');
        navLinks[pageName].querySelector('i').classList.replace('text-gray-500', 'text-blue-600');

        const titles = {
            pos: 'Point of Sale',
            stock: 'Manajemen Stok',
            staff: 'Manajemen Staff',
            dashboard: 'Dashboard'
        };
        pageTitle.textContent = titles[pageName];

        addProductBtn.style.display = (pageName === 'pos' || pageName === 'stock') ? 'flex' : 'none';

        if (pageName === 'stock') renderStockPage();
        if (pageName === 'staff') renderStaffPage();
        if (pageName === 'dashboard') renderDashboard();
    };
    
    window.addToCart = (productId) => {
        const product = products.find(p => p.id === productId);
        const productInCart = cart.find(item => item.id === productId);

        if (product.stock > 0) {
            if (productInCart) {
                if (product.stock > productInCart.quantity) {
                   productInCart.quantity++;
                } else {
                    showToast(`Stok ${product.name} tidak mencukupi`, 'error');
                    return;
                }
            } else {
                cart.push({ id: productId, quantity: 1 });
            }
            renderCart();
        }
    };
    
    window.updateCartQuantity = (productId, change) => {
        const itemIndex = cart.findIndex(item => item.id === productId);
        if (itemIndex > -1) {
            const product = products.find(p => p.id === productId);
            const newQuantity = cart[itemIndex].quantity + change;
            
            if (change > 0 && product.stock <= cart[itemIndex].quantity) {
                showToast(`Stok ${product.name} tidak mencukupi`, 'error');
                return;
            }

            if (newQuantity > 0) {
                cart[itemIndex].quantity = newQuantity;
            } else {
                cart.splice(itemIndex, 1);
            }
            renderCart();
        }
    };

    const handleTransaction = async () => {
        if (cart.length === 0) return;
        if (staff.length > 0 && !staffDropdown.value) {
            showToast('Pilih staff yang bertugas.', 'error');
            return;
        }

        const total = cart.reduce((sum, item) => {
            const product = products.find(p => p.id === item.id);
            return sum + (product.price * item.quantity);
        }, 0);

        const transactionData = {
            id: 'trx-' + Date.now(),
            items: cart,
            total,
            paymentMethod: document.getElementById('payment-method').value,
            staffName: staffDropdown.value,
            customerName: customerNameInput.value.trim(),
            date: new Date().toISOString()
        };
        
        const result = await callAppsScript('processTransaction', transactionData);

        if (result && result.success) {
            showToast('Transaksi berhasil!', 'success');
            cart = [];
            customerNameInput.value = '';
            renderCart();
        } else {
            showToast(result.message || 'Gagal memproses transaksi.', 'error');
        }
    };
    
    // Product Modal Logic
    const showProductModal = (product = null) => {
        productForm.reset();
        document.getElementById('product-id').value = '';

        if (product) {
            modalTitle.textContent = 'Edit Produk';
            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-stock').value = product.stock;
            document.getElementById('product-image').value = product.image;
        } else {
            modalTitle.textContent = 'Tambah Produk Baru';
        }
        productModal.classList.remove('hidden');
    };

    const hideProductModal = () => {
        productModal.classList.add('hidden');
    };

    const handleProductFormSubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('product-id').value;
        const productData = {
            id: id || 'prod-' + Date.now(),
            name: document.getElementById('product-name').value,
            price: parseFloat(document.getElementById('product-price').value),
            stock: parseInt(document.getElementById('product-stock').value, 10),
            image: document.getElementById('product-image').value
        };

        const action = id ? 'updateProduct' : 'addProduct';
        const result = await callAppsScript(action, productData);
        
        if (result && result.success) {
            hideProductModal();
            showToast(`Produk berhasil ${id ? 'diperbarui' : 'ditambahkan'}!`, 'success');
        } else {
            showToast(result.message || 'Gagal menyimpan produk.', 'error');
        }
    };
    
    window.handleEditProduct = (productId) => {
        const product = products.find(p => p.id === productId);
        if (product) showProductModal(product);
    };

    window.handleDeleteProduct = async (productId) => {
        if (confirm(`Apakah Anda yakin ingin menghapus produk ini?`)) {
            const result = await callAppsScript('deleteProduct', { id: productId });
            if (result && result.success) {
                showToast('Produk berhasil dihapus.', 'success');
            } else {
                showToast(result.message || 'Gagal menghapus produk.', 'error');
            }
        }
    };
    
    // Staff Logic
    const handleAddStaff = async (e) => {
        e.preventDefault();
        const newStaffNameInput = document.getElementById('new-staff-name');
        const newStaffName = newStaffNameInput.value.trim();
        if(!newStaffName) return;

        const staffData = { id: 'staff-' + Date.now(), name: newStaffName };
        const result = await callAppsScript('addStaff', staffData);
        if(result && result.success) {
            newStaffNameInput.value = '';
            showToast('Staff berhasil ditambahkan.', 'success');
        } else {
            showToast(result.message || 'Gagal menambahkan staff.', 'error');
        }
    };

    window.handleDeleteStaff = async (staffId) => {
        if (confirm(`Apakah Anda yakin ingin menghapus staff ini?`)) {
            const result = await callAppsScript('deleteStaff', { id: staffId });
            if (result && result.success) {
                showToast('Staff berhasil dihapus.', 'success');
            } else {
                showToast(result.message || 'Gagal menghapus staff.', 'error');
            }
        }
    };

    window.updateStock = async (productId, type) => {
        const input = document.getElementById(`stock-update-${productId}`);
        const value = parseInt(input.value, 10);
        if (isNaN(value) || value <= 0) {
            showToast('Masukkan jumlah yang valid.', 'error');
            return;
        }

        const payload = { id: productId, quantity: value, type };
        const result = await callAppsScript('updateStock', payload);

        if (result && result.success) {
            showToast('Stok berhasil diperbarui.', 'success');
            input.value = ''; // Clear input after success
        } else {
             showToast(result.message || 'Gagal memperbarui stok.', 'error');
        }
    };
    
    // Transaction Edit/Delete Logic
    window.handleEditTransaction = (transactionId) => {
        const transaction = transactions.find(t => t.id === transactionId);
        if(transaction) {
            document.getElementById('edit-transaction-id').value = transaction.id;
            document.getElementById('edit-customer-name').value = transaction.customerName;
            document.getElementById('edit-payment-method').value = transaction.paymentMethod;
            document.getElementById('edit-staff-name').value = transaction.staffName;
            editTransactionModal.classList.remove('hidden');
        }
    };
    
    const handleUpdateTransaction = async (e) => {
        e.preventDefault();
        const transactionId = document.getElementById('edit-transaction-id').value;
        const payload = {
            id: transactionId,
            customerName: document.getElementById('edit-customer-name').value,
            paymentMethod: document.getElementById('edit-payment-method').value,
            staffName: document.getElementById('edit-staff-name').value
        };
        
        const result = await callAppsScript('updateTransaction', payload);
        if(result && result.success){
            editTransactionModal.classList.add('hidden');
            showToast('Transaksi berhasil diperbarui.', 'success');
        } else {
            showToast(result.message || 'Gagal memperbarui transaksi.', 'error');
        }
    };

    window.handleDeleteTransaction = async (transactionId) => {
        if(confirm('Apakah Anda yakin ingin menghapus transaksi ini? Aksi ini tidak dapat dibatalkan.')){
            const result = await callAppsScript('deleteTransaction', { id: transactionId });
            if(result && result.success){
                showToast('Transaksi berhasil dihapus.', 'success');
            } else {
                 showToast(result.message || 'Gagal menghapus transaksi.', 'error');
            }
        }
    };

    window.toggleProductMenu = (productId) => {
        const menu = document.getElementById(`menu-${productId}`);
        menu.classList.toggle('hidden');
    };

    // Close product menu if clicked outside
    document.addEventListener('click', function(event) {
        const openMenus = document.querySelectorAll('[id^="menu-"]:not(.hidden)');
        openMenus.forEach(menu => {
            if (!menu.parentElement.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });
    });

    // =================================================================================
    // INITIALIZATION
    // =================================================================================
    
    // Setup event listeners
    navLinks.pos.addEventListener('click', (e) => { e.preventDefault(); switchPage('pos'); });
    navLinks.stock.addEventListener('click', (e) => { e.preventDefault(); switchPage('stock'); });
    navLinks.staff.addEventListener('click', (e) => { e.preventDefault(); switchPage('staff'); });
    navLinks.dashboard.addEventListener('click', (e) => { e.preventDefault(); switchPage('dashboard'); });
    
    addProductBtn.addEventListener('click', () => showProductModal());
    cancelProductModalBtn.addEventListener('click', hideProductModal);
    productForm.addEventListener('submit', handleProductFormSubmit);
    addStaffForm.addEventListener('submit', handleAddStaff);
    completeTransactionBtn.addEventListener('click', handleTransaction);
    dashboardFilter.addEventListener('change', renderDashboard);
    
    // Transaction edit modal listeners
    cancelEditTransactionBtn.addEventListener('click', () => editTransactionModal.classList.add('hidden'));
    editTransactionForm.addEventListener('submit', handleUpdateTransaction);

    // Load data and start the app
    loadInitialData();
});
</script>
</body>
</html>

